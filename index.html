<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sci-Fi City Dashboard</title>
  <script src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.0.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --panel: rgba(10, 10, 25, 0.5);
      --glow: #00ffffaa;
      --blur: blur(20px);
      --radius: 14px;
      --text: #ffffff;
      --neon: 0 0 8px #0ff, 0 0 16px #0ff;
      
      --gap: 12px;
      --card-w: clamp(180px, 20vw, 280px);
      --ratio: 16/9;
    }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;  /* ✅ ครอบเต็ม viewport */
      width: 100%;
      overflow: hidden;
      background: #000;
      font-family: 'Orbitron', sans-serif;
      font-variant-numeric: tabular-nums; /* ✅ เพิ่มบรรทัดนี้ */
      color: var(--text);
    }

    .layout {
      display: flex;
      height: auto;
      min-height: 100vh;   /* ✅ ไม่ fix ตายตัว แต่ขยายได้ */
      width: 100vw;
      position: relative;
    }

    .background iframe {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      border: none;
      margin: 0;
      padding: 0;
    }

    .top {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 64px;
      background: linear-gradient(to right, rgba(0, 255, 255, 0.1), rgba(0, 0, 0, 0.4));
      backdrop-filter: var(--blur);
      z-index: 3;
      border-bottom: 1px solid var(--glow);
      box-shadow: inset 0 -1px 0 var(--glow);
    }

    .top-left {
      position: absolute;
      left: 28px;
      top: 50%;
      transform: translateY(-50%);
    }

    .top-right {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
    }

    .dashboard-title {
      font-size: 35px;
      font-weight: 600;
      color: var(--text);
      text-shadow: 0 0 6px #0ff;
      white-space: nowrap;
    }

    .top-center {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
    }

    .ios-clock {
      position: absolute;
      top: 68px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      z-index: 4;
    }

    .ios-clock .date {
      font-size: 35px;
      color: #ccc;
      font-weight: 300;
      text-shadow: 0 0 8px rgba(255,255,255,0.15);
    }

    .ios-clock .clock {
      font-size: 70px;
      font-weight: 200;
      color: #fff;
      letter-spacing: -0.5px;
      text-shadow: 0 0 18px rgba(255,255,255,0.25);
    }

    .ios-clock .clock span {
      font-variant-numeric: tabular-nums;
    }

    .menu-buttons {
      display: flex;
      gap: 12px;
    }

    .top button {
      background: transparent;
      border: 1px solid var(--glow);
      color: var(--text);
      padding: 10px 18px;
      border-radius: var(--radius);
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      text-shadow: var(--neon);
      transition: all 0.3s ease;
    }

    .top button:hover {
      background: var(--glow);
      color: #000;
      box-shadow: 0 0 18px var(--glow);
    }

    .menu-buttons button.highlight {
      background: var(--glow);
      color: #000;
      box-shadow: 0 0 18px var(--glow);
    }


    .left, .right {
      position: absolute;
      top: 35px;
      width: 320px;
      height: calc(100vh - 0px);
      /* ทำให้โปร่งใส/ไม่มีพื้นและเงาขอบ */
      background: transparent !important;
      backdrop-filter: none !important;
      border: none !important;
      box-shadow: none !important;

      padding: 0px;
      z-index: 2;
      overflow-y: hidden;
    }

    /* ตำแหน่งซ้าย/ขวา */
    .left { left: 0; }
    .right { right: -20px; }


    .card {
      background: rgba(20, 20, 20, 0.6); /* พื้นเข้มโปร่งใส */
      backdrop-filter: blur(12px);       /* เบลอพื้นหลัง มัวๆ */
      -webkit-backdrop-filter: blur(12px);
      border-radius: 16px;               /* มุมโค้งมน */
      border: 1px solid rgba(255, 255, 255, 0.08); /* ขอบโปร่งบางๆ */
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);   /* เงานุ่มลึก */
      padding: 16px;
      color: #e0e0e0;                    /* ตัวอักษรสีเทาอ่อน อ่านง่ายบนพื้นเข้ม */
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    /* ใส่ effect ตอน hover ให้ล้ำขึ้น */
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.6);
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      padding: 1px;
      border-radius: var(--radius);
      background: linear-gradient(145deg, #00ffff55, #00000022);
      -webkit-mask: 
        linear-gradient(#fff 0 0) content-box, 
        linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }

    h2, h3 {
      text-shadow: var(--neon);
      font-size: 18px;
    }

    ul {
      padding-left: 20px;
      list-style: none;
    }

    ul li::before {
      content: '\25B8';
      color: var(--glow);
      margin-right: 6px;
    }

    .audio-bars-container {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100px;
      background: transparent;
      pointer-events: none;
      z-index: 5;
    }

    .audio-bars-container .bars {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(calc(-50% + 7px)) rotate(180deg);
      display: flex;
      gap: 3px;
    }

    .audio-bars-container .bar {
      width: 4px;
      height: 10px;
      background: #00ffff;
      opacity: 0.5;
      border-radius: 2px;
      transition: height 0.4s ease;
    }

    .electrical-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 18px;             /* ✅ เพิ่มความห่างระหว่างช่อง */
      width: 100%;
      box-sizing: border-box;
    }

    .electrical-grid .metric {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 14px 8px;
      text-align: center;
      min-width: 100px;
      min-height: 80px; /* ✅ เพิ่มความสูงขั้นต่ำ */
      display: flex;
      flex-direction: column;
      justify-content: center;   /* ✅ จัดให้อยู่ตรงกลาง */
      box-shadow: 0 0 10px #0ff4, inset 0 0 8px rgba(255, 255, 255, 0.1);
      transition: transform 0.2s ease;
    }
    .electrical-grid .metric:hover {
      transform: scale(1.03);
    }

    .electrical-grid .metric strong {
      font-size: 13px;               /* ✅ ลดขนาด font นิดหน่อย */
      white-space: nowrap;           /* ✅ ไม่ให้พับ */
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
      margin-bottom: 6px;
      color: #0ff;
    }

    .electrical-grid .metric div {
      font-size: 20px;
      font-weight: 600;
      overflow-wrap: break-word;
      word-break: break-word;
      font-variant-numeric: tabular-nums;
    }

    @media (max-width: 600px) {
      .electrical-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Fade-in/out glass modal */
    .glass-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.6s ease;
    }

    .glass-modal.active {
      opacity: 1;
      pointer-events: auto;
    }

    .glass-content {
      background: rgba(0, 0, 0, 0.6);
      padding: 24px;
      border-radius: 16px;
      width: 90vw;
      max-width: 1280px;
      height: 90vh;
      box-shadow: 0 0 30px #0ff;
      position: relative;
    }

    .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #0ff;
      color: #000;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      padding: 8px 16px;
      cursor: pointer;
    }


    @keyframes fadeIn {
      0% {
        transform: scale(0.92);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .glass-modal {
      position: fixed;
      top: 70px;
      left: 51.5%;
      transform: translateX(-50%);
      width: 90vw;                /* กว้างเท่าเดิม */
      max-width: 1280px;
      height: 82vh;               /* ✅ เพิ่มความสูงมากขึ้น */
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      box-shadow: 0 0 25px #00ffffaa;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
      overflow: hidden;
    }

    .glass-modal.active {
      opacity: 1;
      pointer-events: auto;
    }

    .glass-modal .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #0ff;
      color: #000;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      z-index: 20;
    }
    
    /* === Frame ของโมดัลกล้อง === */
    .glass-modal-cctv {
      position: fixed;
      top: 220px;
      right: 500px;
    
      /* กรอบขนาดพอดีกับรูป */
      display: inline-block;
      width: auto;
      height: auto;
    
      /* Glass effect */
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      border: 1px solid rgba(255, 255, 255, 0.2);
    
      /* ให้ขอบโค้งที่ container ไปเลย */
      border-radius: 16px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    
      /* ❌ ไม่ต้องมี padding ไม่งั้นกรอบใหญ่กว่ารูป */
      padding: 0;     
    
      display: none;
      z-index: 9999;
      overflow: hidden;  /* ให้ภาพไม่ล้น */
    }
    
    .glass-modal-cctv.active {
      display: inline-block;
    }
    
    .glass-modal-cctv img {
      display: block;     /* ตัดช่องว่างใต้รูป */
      width: 300px;       /* ✅ ล็อกที่ 300px */
      height: auto;
      border-radius: 0;   /* ใช้ border-radius จาก container แทน */
    }

    
    /* ปุ่มปิดยังใช้ตำแหน่งเดิมได้ */
    .glass-modal-cctv .close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 2;
    }


    .scrolling-wrapper {
      position: relative;
      height: 100%;
      overflow: hidden;
    }

    .scrolling-content {
      position: absolute;
      width: 100%;
      animation: scroll-up-down-right 300s ease-in-out infinite;
    }
    
    .scrolling-content-left {
      position: absolute;
      width: 100%;
      animation: scroll-up-down-left 300s ease-in-out infinite;
    }
    
    .camera-image img {
        display: block; 
        margin-left: auto; 
        margin-right: auto;
        width: 100%;
        height: auto;
        border-radius: 8px;
        border: 1px solid #00eaff;
        box-shadow: 0 0 12px #00eaff66;
        margin-bottom: 8px;
        transition: transform 0.3s ease;
    }
    
    .camera-image img:hover {
        transform: scale(1.03);
    }

    @keyframes scroll-up-down-left {
      0%   { transform: translateY(0); }
      25%  { transform: translateY(-1400px); }
      50%  { transform: translateY(0); }
      75%  { transform: translateY(-1400px); }
      100% { transform: translateY(0); }
    }

    @keyframes scroll-up-down-right {
      0%   { transform: translateY(0); }
      25%  { transform: translateY(-2350px); }
      50%  { transform: translateY(0); }
      75%  { transform: translateY(-2350px); }
      100% { transform: translateY(0); }
    }
    
      #groupedBar {
        width: 100%;
        height: 280px;          /* ปรับความสูงตามต้องการ */
      }
      @media (min-width: 1360px) {
        #groupedBar { height: 320px; }
      }
      
    #pie {
      width: 80%;
      height: 80%;
      box-shadow: 0 0 20px #00ffffaa;
      border-radius: 12px;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(12px);
      padding: 8px;
    }
    
    select, button { background:#000; color:#0ff; border:1px solid #0ff; padding:6px 12px; border-radius:6px; cursor:pointer; }
    select option { background:#000; color:#0ff; }
    #dashboard3D { width:100%; height:95vh; }
    #legendToggle { margin-left: auto; }
    
      /* === 3D Model แบบเต็มจอ === */
      #skfb-frame{
        position:fixed; inset:0;
        width:100vw; height:100vh; border:none;
        filter: drop-shadow(0 0 20px #00eaff);
        z-index: 1; /* อยู่ใต้ overlay ทั้งหมด */
      }
    
    .cctv-col-left, .cctv-col-right, .cctv-col-center{
      position: fixed;
      bottom: var(--safe-bottom);
      display: flex;
      flex-direction: column;
      gap: var(--gap);
      z-index: 10000;
      pointer-events: none; /* คลิกทะลุ ยกเว้นตัวการ์ด */
    }
    
    /* เพิ่มขนาดสำหรับกล้องกลาง */
    .cctv-col-center .glass-card {
      width: calc(var(--card-w) * 1.5); /* กล้องกลางใหญ่ขึ้น 1.5 เท่า */
      aspect-ratio: var(--ratio);       /* ยังคงอัตราส่วนภาพเดิม */
    }
    
    .cctv-col-left { left: 340px; }
    .cctv-col-center { top: 50%; left: 50%; }
    .cctv-col-right{ right: 300px; }
    
    .glass-card{
      position: relative;
      width: var(--card-w);
      aspect-ratio: var(--ratio);
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 22px rgba(0,0,0,.35);
      pointer-events: auto;
    }
    
    .glass-card img{
      width: 100%; height: 100%;
      object-fit: cover;
      display: block;
    }
    
    .glass-card h3{
      position: absolute;
      top: 6px; right: 6px;
      margin: 0; padding: 4px 8px;
      background: rgba(0,0,0,.55);
      color: #00fff3;
      font: 700 12px/1 'Orbitron', sans-serif;
      border-radius: 8px;
    }
    
    .glass-card h32{
      position: absolute;
      bottom: 6px; left: 6px;
      margin: 0; padding: 4px 8px;
      background: rgba(0,0,0,.55);
      color: #00fff3;
      font: 700 12px/1 'Orbitron', sans-serif;
      border-radius: 8px;
    }
    
    /* Responsive */
    @media (max-width: 1200px){
      :root{ --card-w: clamp(160px, 28vw, 240px); }
    }
    @media (max-width: 768px){
      .cctv-col-left, .cctv-col-right, .cctv-col-center{
        flex-direction: row; /* จอเล็ก → จัดเรียงเป็นแถวแทน */
        bottom: var(--safe-bottom);
        top: auto;
      }
    }
    
/* === PS5-like Glass Card ================================== */
.floor-card{
  width: 240px; height: 120px;
  position: relative; overflow: hidden;
  border-radius: 16px;

  /* Glass effect */
  background:
    linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06)),
    rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.22);
  backdrop-filter: blur(16px) saturate(160%);
  -webkit-backdrop-filter: blur(16px) saturate(160%);

  /* Shadow + neon glow */
  box-shadow:
    0 18px 30px rgba(0,0,0,.40),
    inset 0 1px 0 rgba(255,255,255,.25),
    0 0 26px rgba(0,246,255,.18);

  display:flex; flex-direction:column;
  justify-content:center; align-items:flex-end;
  padding: 18px 24px;
  transition: transform .35s ease, box-shadow .35s ease, border-color .35s ease;
}

/* ✨ Neon top bar (flow animation) */
.floor-card::before{
  content:"";
  position:absolute; left:0; right:0; top:0; height:40px;
  background: linear-gradient(270deg, #00f6ff, #9b4dff, #00f6ff);
  background-size: 280% 100%;
  animation: barFlow 7s ease-in-out infinite;
  box-shadow: 0 0 12px rgba(0,246,255,.65), 0 0 20px rgba(155,77,255,.45);
  border-top-left-radius:16px; border-top-right-radius:16px;
  opacity:.9;
}

/* Glass reflection highlight */
.floor-card::after{
  content:"";
  position:absolute; inset:-20% -10% auto -10%;
  height:70%;
  background:
    radial-gradient(120% 70% at 15% -30%,
      rgba(255,255,255,.38), rgba(255,255,255,.10) 40%, transparent 70%);
  pointer-events:none;
  mix-blend-mode:screen;
}

/* Sheen light */
.floor-card .sheen{
  position:absolute; inset:-40% -50% -40% -50%;
  background: linear-gradient(120deg,
    transparent 40%,
    rgba(255,255,255,.20) 50%,
    transparent 60%);
  transform: translateX(-30%);
  animation: sheen 4.5s ease-in-out infinite;
  pointer-events:none;
  mix-blend-mode:screen;
  opacity:.55;
}

/* Text */
.label{
  font-size:18px; letter-spacing:2px;
  color:#cfefff; opacity:.85;
  align-self:flex-start;
  position:relative; top:20px;
}
.number {
  font-size: 66px; font-weight: 900;
  color: #00f6ff;
  text-shadow: 0 0 12px #00f6ff, 0 0 28px #9b4dff;
  display: inline-block;      /* เพื่อให้ translate ทำงานชัวร์ */
  transform: translateY(18px); /* 👈 เลื่อนลง ~6px (ปรับค่าตามชอบ) */
  /* หรือถ้าชอบแบบง่าย ๆ: margin-top: 6px; */
}

/* Hover focus effect */
.floor-card:hover{
  transform: translateY(-4px) scale(1.02);
  border-color: rgba(255,255,255,.30);
  box-shadow:
    0 22px 36px rgba(0,0,0,.45),
    inset 0 1px 0 rgba(255,255,255,.30),
    0 0 36px rgba(0,246,255,.28);
}

/* Animations */
@keyframes barFlow{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
@keyframes sheen{
  0%, 100%{transform: translateX(-35%) rotate(0.001deg)}
  50%{transform: translateX(35%) rotate(0.001deg)}
}


/* ===== Floor Switcher (under clock) ===== */
/* ===== Isometric Floor Switcher (scoped เฉพาะใน .floor-switcher) ===== */
.floor-switcher{ pointer-events:none; display:grid; place-items:center; width:min(92vw,980px); margin:0 auto; }
.floor-switcher .iso{ position:relative; height:300px; width:min(92vw,740px); perspective:1200px; user-select:none; pointer-events:auto; }
.floor-switcher .stack{ position:relative; transform: rotateX(58deg) rotateZ(-32deg) translateY(-12px); transform-style:preserve-3d; }

.floor-switcher .layer{
  --z:0;
  position:absolute; left:0; top:0;
  width:260px; height:160px; border-radius:18px;
  background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06)), rgba(255,255,255,.05);
  border:1px solid rgba(0,255,255,.38);
  box-shadow: 0 28px 44px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.32);
  transform: translate3d(calc(var(--z)*6px), calc(var(--z)*-18px), calc(var(--z)*34px));
  transition: transform .45s cubic-bezier(.2,.8,.2,1), box-shadow .35s, border-color .35s, filter .35s, opacity .35s;
  display:grid; place-items:center; overflow:hidden;
}
.floor-switcher .layer::before{
  content:""; position:absolute; inset:-1px; border-radius:inherit; pointer-events:none;
  background: linear-gradient(140deg, rgba(0,255,255,.55), rgba(0,255,255,0) 30%, rgba(154,77,255,.45));
  mix-blend-mode:screen; opacity:.25; transition:opacity .3s ease;
}
.floor-switcher .layer::after{
  content:attr(data-label); position:absolute; inset:0; display:grid; place-items:center;
  font-weight:800; font-size:22px; letter-spacing:.2em; color:#dff; text-shadow:0 0 10px rgba(0,255,255,.35);
}
.floor-switcher .layer .bar{
  position:absolute; left:0; right:0; top:0; height:38px; border-top-left-radius:inherit; border-top-right-radius:inherit;
  background: linear-gradient(270deg, #00f6ff, #9b4dff, #00f6ff); background-size:260% 100%;
  animation: barFlow 7s ease-in-out infinite; box-shadow: 0 0 14px rgba(0,246,255,.6), 0 0 20px rgba(155,77,255,.4); opacity:.9;
  transition: box-shadow .3s ease, filter .3s ease;
}
.floor-switcher .iso:hover .layer{
  transform: translate3d(calc(var(--z)*12px), calc(var(--z)*-28px), calc(var(--z)*52px));
  filter:saturate(130%); box-shadow: 0 38px 60px rgba(0,0,0,.6), 0 0 26px rgba(0,255,255,.25) inset;
}
.floor-switcher .layer.active{
  border-color: rgba(0,255,255,.85);
  box-shadow: 0 0 30px rgba(0,255,255,.55), inset 0 0 0 1px rgba(0,255,255,.35), 0 28px 44px rgba(0,0,0,.55);
}
.floor-switcher .hit{ position:absolute; inset:0; border-radius:inherit; cursor:pointer; }

/* โหมดทั้งตึก (เมื่อกด BPS): ให้ทุกชั้นปล่อยแสงพร้อมกัน */
.floor-switcher .stack.all-mode .layer{
  border-color: rgba(0,255,255,.85);
  filter:saturate(145%);
  animation: neonPulse 1.9s ease-in-out infinite;
  animation-delay: var(--delay,0s);
}
.floor-switcher .stack.all-mode .layer::before{ opacity:.38; }
.floor-switcher .stack.all-mode .layer .bar{ animation-duration:3s; box-shadow:0 0 18px rgba(0,246,255,.85), 0 0 26px rgba(155,77,255,.55); filter:saturate(160%); }

@keyframes neonPulse{
  0%,100%{ box-shadow: 0 28px 44px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.32), 0 0 0 rgba(0,255,255,0); }
  50%{ box-shadow: 0 28px 44px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.42), 0 0 26px rgba(0,255,255,.45), 0 0 40px rgba(155,77,255,.35); }
}

/* ปุ่มด้านล่าง (ใช้คลาส .chips/.chip เดิมเพื่อกลมกลืนสไตล์) */
.floor-switcher .chips{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px; pointer-events:auto; }
.floor-switcher .chips .chip.building{ background:rgba(0,255,255,.14); color:#001316; border-color:rgba(0,255,255,.65); }

/* ย่อบนมือถือ */
@media (max-width:740px){
  .floor-switcher .iso{ height:240px; }
  .floor-switcher .layer{ width:220px; height:136px; }
}

/* === Place floor switcher bottom-center === */
.floor-switcher{
  position: fixed;          /* ลอยทับหน้า */
  left: 50%;
  top: 900%;
  bottom: var(--safe-bottom);  /* เลี่ยงชนแถวกล้องล่าง ถ้าจะชิดมากขึ้นปรับเป็น 16px ก็ได้ */
  transform: translateX(-50%);
  width: min(92vw, 980px);
  z-index: 10002;           /* อยู่เหนือ iframe/พื้นหลังแน่ ๆ */
  pointer-events: none;     /* ให้คลิกได้เฉพาะของด้านใน */
}

/* ปุ่มข้างในต้องคลิกได้ */
.floor-switcher .chips{ pointer-events: auto; }

/* ถ้าต้องการให้เห็นเฉพาะปุ่ม ไม่แสดงกอง isometric ให้เปิดบรรทัดนี้ */
/* .floor-switcher .iso{ display:none; } */

/* มือถือ: ให้ชิดขอบล่างขึ้นอีกหน่อย */
@media (max-width: 768px){
  .floor-switcher{ bottom: 16px; }
}


    
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="layout">
    <div class="background">
      <iframe id="skfb-frame" allow="autoplay; fullscreen; xr-spatial-tracking" allowfullscreen></iframe>
    </div>


    <!-- กล้องแนวตั้งฝั่งซ้าย -->
    <div class="cctv-col-left">
      <h3 id="cameraNameBox1"></h3>
      <div id="CCTV1" class="glass-card"><h32 id="name1">-</h32><img id="modalImg1"><h3 id="datetime1">-</h3></div>
      <div id="CCTV2" class="glass-card"><h32 id="name2">-</h32><img id="modalImg2"><h3 id="datetime2">-</h3></div>
      <div id="CCTV3" class="glass-card"><h32 id="name3">-</h32><img id="modalImg3"><h3 id="datetime3">-</h3></div>
      <div id="CCTV4" class="glass-card"><h32 id="name4">-</h32><img id="modalImg4"><h3 id="datetime4">-</h3></div>
    </div>
    
    <!-- กล้องแนวตั้งกลาง -->
    <div class="cctv-col-center">
      <div id="CCTV9" class="glass-card"><h32 id="name9">-</h32><img id="modalImg9"><h3 id="datetime9">-</h3>
      </div>
    </div>
    
    <!-- กล้องแนวตั้งฝั่งขวา -->
    <div class="cctv-col-right">
      <h3 id="cameraNameBox2"></h3>
      <div id="CCTV5" class="glass-card"><h32 id="name5">-</h32><img id="modalImg5"><h3 id="datetime5">-</h3></div>
      <div id="CCTV6" class="glass-card"><h32 id="name6">-</h32><img id="modalImg6"><h3 id="datetime6">-</h3></div>
      <div id="CCTV7" class="glass-card"><h32 id="name7">-</h32><img id="modalImg7"><h3 id="datetime7">-</h3></div>
      <div id="CCTV8" class="glass-card"><h32 id="name8">-</h32><img id="modalImg8"><h3 id="datetime8">-</h3></div>
    </div>

    <div class="top">
      <div class="top-left">
        <div class="dashboard-title" id="animatedTitle"></div>
      </div>
      <div class="top-right">
        <a href="https://postimg.cc/21pssXr5" target="_blank">
          <img src="https://i.postimg.cc/Z50Jy1Q6/BPS-LOGO-1.gif" alt="BPS Logo" style="width: 85px; height: auto;">
        </a>
      </div>
      <div class="top-center">
        <div class="menu-buttons">
          <button onclick="runDemo()">▶ Auto View</button>
          <button onclick="openLogistics('logisticsCenterModal')">Logistics</button>
          <button onclick="openLogistics('CCTVSecurity')">CCTV Security</button>
          <button onclick="openLogistics('CCTV-WH')">CCTV-WH</button>
          <button onclick="openLogistics('CCTV-UDS')">CCTV-UDS</button>
          <button onclick="openLogistics('CCTV-HQ')">CCTV-HQ</button>
          <button onclick="openLogistics('ElectricalSystem')">Electrical System</button>
          <button onclick="openLogistics('WaterSystem')">Water System</button>
          <button onclick="openLogistics('FreshAir')">Fresh Air</button>
          <button onclick="openLogistics('SolarCell')">Solar Cell</button>
          <button onclick="openLogistics('FiberOptic')">Fiber Optic</button>
        </div>

      <!-- ใต้ .top-center -->
      <div class="ios-clock">
        <div class="date" id="date">--</div>
        <div class="clock"><span id="clock">--:--</span></div>
      </div>
      
        <!-- ✅ Floor switcher under clock -->
        <div class="floor-switcher">
          <!-- Isometric stack (no BPS layer) -->
          <div class="iso" id="isoIso">
            <div class="stack" id="isoStack"></div>
          </div>
          <!-- ปุ่ม (มี BPS) -->
          <div class="chips" id="isoChips"></div>
        </div>


      </div>
    </div>

    <div id="miniPanel" style="
      display: none;
      position: absolute;
      top: 120px; /* ใต้เวลา */
      left: 320px; /* ชิดหลัง block ซ้าย (ความกว้าง 320px) */
      right: 320px; /* ไม่ชน block ขวา */
      background-color: rgba(0, 0, 0, 0.7);
      border: 1px solid #0ff;
      border-radius: 14px;
      box-shadow: 0 0 20px #0ff;
      padding: 24px;
      z-index: 20;
      backdrop-filter: blur(14px);
      color: white;
      font-family: sans-serif;
    ">

      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; color: #0ff;">Logistics</h3>
        <button onclick="toggleMiniPanel()" style="
          background: #0ff;
          color: #000;
          border: none;
          padding: 6px 12px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
        ">Close</button>
      </div>
      <iframe src="https://lookerstudio.google.com/embed/reporting/2a55735c-1218-4170-8696-db6f06ad0725/page/p_pmwprespbd"
        style="width:100%; height:700px; border:none; margin-top:14px; border-radius:10px;"></iframe>
    </div>


    <div class="left">
      <div class="card">
        <h3></h3>
        <div class="floor-card">
          <span class="label" id="BuildorFloor"></span>
          <span class="number" id="NumberFloor">-</span>
        </div>
        <div class="camera-image"><img id="modalImg0"></div>
        
        <button onclick="openLogistics('BUILDING_OVERVIEW')">BUILDING OVERVIEW</button>
      </div>
      
      <div class="scrolling-wrapper">
      <div class="scrolling-content-left">
      <div class="card">
        <h3>
          <svg width="20" height="20" fill="#0ff" viewBox="0 0 24 24">
            <path d="M2 4h20v2H2V4zm2 4h16v3l3 3v2H1v-2l3-3V8zm2 2v2h12v-2H6zm1 6h10v2H7v-2z"/>
          </svg> CCTV Security
        </h3>
          <div class="electrical-grid">
            <div class="metric">
              <strong style="color: #0ff;">Offline</strong>
              <div id="infoBox2">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Intruder</strong>
              <div id="infoBox3">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Online</strong>
              <div id="infoBox4">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Total</strong>
              <div id="infoBox5">-</div>
            </div>
          </div><br></br>
          <div id="groupedBar"></div>
      </div>
      
      
      <div class="card">
        <h3>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="13 2 3 14 12 14 11 22 21 10 13 10 13 2" />
          </svg>
           Electrical System
        </h3>
          <div class="electrical-grid">
            <div class="metric">
              <strong style="color: #0ff;">Voltage</strong>
              <div id="infoBox6">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Current</strong>
              <div id="infoBox7">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Frequency</strong>
              <div id="infoBox8">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Power</strong>
              <div id="infoBox9">-</div>
            </div>
          </div><br></br>
          <h3>Electrical Floor Distribution</h3>
          <div id="floorDonut" style="width:100%; height:300px;"></div>
      </div>
      
      <div class="card">
        <h3> 
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2C12 2 5 9 5 14a7 7 0 0014 0c0-5-7-12-7-12z"/>
          </svg>
          Water System
        </h3>
          <div class="electrical-grid">
            <div class="metric">
              <strong style="color: #0ff;">Flow Rate</strong>
              <div id="infoBox10">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Duration (Days)</strong>
              <div id="infoBox11">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Duration (Months)</strong>
              <div id="infoBox12">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Water Usage</strong>
              <div id="infoBox13">-</div>
            </div>
          </div><br></br>
              <div id="area" style="width:100%; height:300px;"></div>
      </div>
      </div>
      </div>
    </div>

    <div class="right">
        <div class="card">
          <h3>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M2 12h20M2 6h16M2 18h12"/>
            </svg>
            3D Digital Twin Dashboard
          </h3>
          
          <button onclick="openLogistics('3D_Digital')">3D Digital Twin</button>

          <button onclick="openLogistics('4D_Digital')">4D Digital Twin</button>
          
          <!-- Controls สำหรับเลือก Floor, System, Parameter -->
          <div class="controls" style="margin-bottom:12px;">
            <select id="floorSelect3D">
              <option value="ALL">All Floors</option>
              <option value="1st_Floor">1st Floor</option>
              <option value="M_Floor">M Floor</option>
              <option value="2nd_Floor">2nd Floor</option>
              <option value="3rd_Floor">3rd Floor</option>
              <option value="4th_Floor">4th Floor</option>
              <option value="5th_Floor">5th Floor</option>
            </select>
        
            <select id="systemSelect3D">
              <option value="ALL">All Systems</option>
              <option value="CCTV">CCTV</option>
              <option value="Electrical">Electrical</option>
              <option value="Water">Water</option>
              <option value="Air">Air</option>
            </select>
        
            <select id="paramSelect3D">
              <option value="ALL">All Parameters</option>
            </select>
        
            <button id="legendToggle3D">Show Legend</button>
          </div>
        
          <!-- แสดงผล Plotly 3D -->
          <div id="dashboard3D" style="width:100%; height:200px;"></div>
        </div>

    <div class="scrolling-wrapper">
      <div class="scrolling-content">
      <div class="card">
        <h3>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M2 12h20M2 6h16M2 18h12"/>
          </svg>
          Fresh Air
        </h3>
          <div class="electrical-grid">
            <div class="metric">
              <strong style="color: #0ff;">Temp</strong>
              <div id="infoBox14">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Humidity</strong>
              <div id="infoBox15">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">PM2d5</strong>
              <div id="infoBox16">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">PM10</strong>
              <div id="infoBox17">-</div>
            </div>
          </div>
          <div class="electrical-grid">
            <div class="metric">
              <strong style="color: #0ff;">TVOC</strong>
              <div id="infoBox18">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">CH2O</strong>
              <div id="infoBox19">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">CO2</strong>
              <div id="infoBox20">-</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">N2</strong>
              <div id="infoBox21">-</div>
            </div>
          </div><br></br>
            <div id="radar" style="width:100%; height:300px;"></div>
            
          <h3>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M2 12h20M2 6h16M2 18h12"/>
            </svg>
            Holographic 4D Dashboard
          </h3>
        
          <!-- Controls -->
          <div class="controls" style="margin-bottom:12px;">
            Floor:
            <select id="floorSelect4D">
              <option value="ALL">All Floors</option>
              <option value="1st_Floor">1st Floor</option>
              <option value="M_Floor">M Floor</option>
              <option value="2nd_Floor">2nd Floor</option>
              <option value="3rd_Floor">3rd Floor</option>
              <option value="4th_Floor">4th Floor</option>
              <option value="5th_Floor">5th Floor</option>
            </select>
        
            Parameter:
            <select id="paramSelect4D">
              <option value="CO2">CO2</option>
              <option value="Temperature">Temperature</option>
              <option value="Humidity">Humidity</option>
              <option value="PM2.5">PM2.5</option>
            </select>
          </div>
        
          <!-- Plotly 3D Container -->
          <div id="dashboard4D" style="width:100%; height:400px; border-radius:12px;"></div>

      </div>
      <div class="card">
        <h3>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
          </svg> Solar Cell
        </h3>
          <div class="electrical-grid">
            <div class="metric">
              <strong style="color: #0ff;">Online</strong>
              <div>77<br>Sites</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Offline</strong>
              <div>21<br>Sites</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Fault</strong>
              <div>7<br>Sites</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Total</strong>
              <div>105<br>Sites</div>
            </div>
          </div><br></br>
          
          <h3>Solar Halo (Power vs Time)</h3>
          <div id="solarHalo" style="width:100%; height:320px;"></div>

          <h3>Daily Energy – Calendar Heatmap</h3>
          <div id="solarCal" style="width:100%; height:320px;"></div>

      </div>
      <div class="card">
        <h3>
          <svg width="24" height="24" viewBox="0 0 640 512" fill="none" stroke="#0ff" stroke-width="24" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
            <path d="M624 352h-16V256c0-26.5-21.5-48-48-48h-64l-64-96H272c-26.5 0-48 21.5-48 48v192H80c-26.5 0-48 21.5-48 48s21.5 48 48 48h32c0 35.3 28.7 64 64 64s64-28.7 64-64h160c0 35.3 28.7 64 64 64s64-28.7 64-64h16c26.5 0 48-21.5 48-48s-21.5-48-48-48zM400 128h49.6l38.4 64H400V128zM176 448c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm288 0c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm96-96H80v-16h480v16z"/>
          </svg> Logistics
        </h3>
          <div class="electrical-grid">
            <div class="metric">
              <strong style="color: #0ff;">Value</strong>
              <div>2.0<br>Million</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Waiting</strong>
              <div>40<br>Orders</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Sent</strong>
              <div>60<br>Orders</div>
            </div>
            <div class="metric">
              <strong style="color: #0ff;">Total</strong>
              <div>100<br>Orders</div>
            </div>
          </div><br></br>
          <div id="stackedBar"></div>
      </div>
      
      <br>
        </div>
    </div>
    </div>
  </div>
  
  
    <div id="CCTV" class="glass-modal-cctv">
      <img id="modalImg"
           src=""
           alt="ภาพจากกล้อง" />
      <h3 id="infoBox1">-</h3>
      <h3>Entry - 90P | Exit - 90P</h3>
      <button class="close-btn" onclick="closeLogistics('CCTV')">❌</button>
    </div>
  
  
  <div id="BUILDING_OVERVIEW" class="glass-modal">
    <iframe src="https://supakit148.github.io/BUILDING-OVERVIEW/"
            style="width:100%; height:100%; border:none; border-radius: 16px;"></iframe>
    <button class="close-btn" onclick="closeLogistics('BUILDING_OVERVIEW')">❌</button>
  </div>
  
  <div id="3D_Digital" class="glass-modal">
    <iframe src="https://supakit148.github.io/3D-Graph-Digital-Twin/"
            style="width:100%; height:100%; border:none; border-radius: 16px;"></iframe>
    <button class="close-btn" onclick="closeLogistics('3D_Digital')">❌</button>
  </div>
  
  <div id="4D_Digital" class="glass-modal">
    <iframe src="https://supakit148.github.io/4D-Graph-Digital-Twin/"
            style="width:100%; height:100%; border:none; border-radius: 16px;"></iframe>
    <button class="close-btn" onclick="closeLogistics('4D_Digital')">❌</button>
  </div>

  <div id="logisticsCenterModal" class="glass-modal">
    <iframe src="https://lookerstudio.google.com/embed/reporting/2a55735c-1218-4170-8696-db6f06ad0725/page/p_pmwprespbd"
            style="width:100%; height:100%; border:none; border-radius: 16px;"></iframe>
    <button class="close-btn" onclick="closeLogistics('logisticsCenterModal')">❌</button>
  </div>

  <div id="CCTVSecurity" class="glass-modal">
    <iframe src="https://bpstech.online/d/e7cd0ba2-b2c8-4163-a95e-b6d540feb2f3/cctv-5-2-only-granfana?orgId=1&refresh=5s&from=1752598800000&to=1752632865506"
            style="width:100%; height:100%; border:none; border-radius: 16px;"></iframe>
    <button class="close-btn" onclick="closeLogistics('CCTVSecurity')">❌</button>
  </div>

  <div id="CCTV-WH" class="glass-modal">
    <iframe src="https://supakit148.github.io/smart-dashboard/"
            style="width:100%; height:100%; border:none; border-radius: 16px;"></iframe>
    <button class="close-btn" onclick="closeLogistics('CCTV-WH')">❌</button>
  </div>

  <div id="CCTV-UDS" class="glass-modal">
    <iframe src="https://supakit148.github.io/CCTV-UDS/"
            style="width:100%; height:100%; border:none; border-radius: 16px;"></iframe>
    <button class="close-btn" onclick="closeLogistics('CCTV-UDS')">❌</button>
  </div>

  <div id="CCTV-HQ" class="glass-modal">
    <iframe src="https://supakit148.github.io/CCTV-HQ/"
            style="width:100%; height:100%; border:none; border-radius: 16px;"></iframe>
    <button class="close-btn" onclick="closeLogistics('CCTV-HQ')">❌</button>
  </div>

  <div id="ElectricalSystem" class="glass-modal">
    <iframe src="https://bpstech.online/d/ad6df34b-7a83-4795-9f4f-fcb54b5024cf/evoair-rev1?orgId=1&from=1752549386683&to=1752552986683"
            style="width:100%; height:100%; border:none; border-radius: 16px;"></iframe>
    <button class="close-btn" onclick="closeLogistics('ElectricalSystem')">❌</button>
  </div>

  <div id="WaterSystem" class="glass-modal">
    <iframe src="https://bpstech.online/d/e398f637-3c20-4529-9ff4-517e8bf2b7d5/2ea5407a-6f7f-5825-8d08-da9c3d368296?orgId=1&refresh=5s&from=1735664400000&to=1767200399999"
            style="width:100%; height:100%; border:none; border-radius: 16px;"></iframe>
    <button class="close-btn" onclick="closeLogistics('WaterSystem')">❌</button>
  </div>

  <div id="FreshAir" class="glass-modal">
    <iframe src="https://bpstech.online/d/e292748b-da2c-4d29-9990-0262a6cd519e/air-q-demo-rev0?orgId=1&refresh=5s&from=1752551302736&to=1752553102736"
            style="width:100%; height:100%; border:none; border-radius: 16px;"></iframe>
    <button class="close-btn" onclick="closeLogistics('FreshAir')">❌</button>
  </div>

  <div id="SolarCell" class="glass-modal">
    <iframe src="https://lh3.googleusercontent.com/d/1VP3-U0l0QxFb8b-R3puq7EBJQcCKAITs"
            style="width:100%; height:100%; border:none; border-radius: 16px;"></iframe>
    <button class="close-btn" onclick="closeLogistics('SolarCell')">❌</button>
  </div>

  <div id="FiberOptic" class="glass-modal">
    <iframe src="https://bpstech.online/d/fe15b960-5bda-4051-b87b-2bbec6d29461/project-fiber-check-material-rev1?orgId=1&from=1753376400000&to=1753416393714"
            style="width:100%; height:100%; border:none; border-radius: 16px;"></iframe>
    <button class="close-btn" onclick="closeLogistics('FiberOptic')">❌</button>
  </div>

  <!-- 🔊 Audio Visualizer -->
  <div class="audio-bars-container">
    <div class="bars" id="audioBars"></div>
  </div>

  <script>
    // Visualizer
    const barCount = 90;
    const container = document.getElementById('audioBars');
    for (let i = 0; i < barCount; i++) {
      const bar = document.createElement('div');
      bar.className = 'bar';
      container.appendChild(bar);
    }
    setInterval(() => {
      document.querySelectorAll('.audio-bars-container .bar').forEach(bar => {
        const height = Math.floor(Math.random() * 60) + 20;
        bar.style.height = `${height}px`;
      });
    }, 250);

    // Title Animation
    const titleElement = document.getElementById('animatedTitle');
    const fullText = 'Digital Twin';
    const codeChars = '█▓▒░<>#@*%&?!';
    let currentIndex = 0;
    let animationStep = 0;
    let displayText = '';
    let isDeleting = false;

    function scrambleText(text, length) {
      let scrambled = '';
      for (let i = 0; i < length; i++) {
        scrambled += codeChars.charAt(Math.floor(Math.random() * codeChars.length));
      }
      return scrambled;
    }

    function animateTitle() {
      if (!isDeleting) {
        if (currentIndex < fullText.length) {
          displayText = fullText.substring(0, currentIndex + 1);
          const scrambled = scrambleText('', fullText.length - currentIndex - 1);
          titleElement.innerText = displayText + scrambled;
          currentIndex++;
        } else {
          if (animationStep < 15) {
            animationStep++;
          } else {
            isDeleting = true;
            animationStep = 0;
          }
        }
      } else {
        if (currentIndex > 0) {
          currentIndex--;
          displayText = fullText.substring(0, currentIndex);
          const scrambled = scrambleText('', fullText.length - currentIndex);
          titleElement.innerText = displayText + scrambled;
        } else {
          isDeleting = false;
        }
      }
      setTimeout(animateTitle, 80);
    }

    animateTitle();
  </script>

  <script>
    function updateClock() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      document.getElementById('clock').textContent = `${hours}:${minutes}:${seconds}`;

      const options = { weekday: 'long', month: 'long', day: 'numeric' };
      const dateString = now.toLocaleDateString(undefined, options);
      document.getElementById('date').textContent = dateString;
    }

    updateClock();
    setInterval(updateClock, 1000);
  </script>

  <script>
  fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vSCb61sTIyqhqss13xwnWnANho_EXFOIJK_oa3Ig1a6audH72wrWCwGaJwv8XMuaUxamCldtrDolHVr/pub?gid=0&single=true&output=csv")
    .then(response => response.text())
    .then(csv => {
      const rows = csv.trim().split("\n").map(r => r.split(","));
      let html = '<table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; font-size:16px; width:100%;">';

      // Header
      html += "<thead><tr>";
      rows[0].forEach(col => html += `<th>${col}</th>`);
      html += "</tr></thead><tbody>";

      // Data
      for (let i = 1; i < rows.length; i++) {
        html += "<tr>";
        rows[i].forEach(cell => {
          let color = "";
          if (cell.toLowerCase().includes("offline")) {
            color = "color: white;";
          } else if (cell.toLowerCase().includes("online")) {
            color = "color: white;";
          }
          html += `<td style="${color}">${cell}</td>`;
        });
        html += "</tr>";
      }

      html += "</tbody></table>";
      document.getElementById("cctv-status-table").innerHTML = html;
    });
  </script>

  <script>
  fetch("https://docs.google.com/spreadsheets/d/1723prYCtb3ySIGvHYZDkekWP97k8IiKd5-pm9php-JE/export?format=csv&gid=456184011")
    .then(response => response.text())
    .then(csv => {
      const rows = csv.trim().split("\n").map(r => r.split(","));
      let html = '<table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; font-size:16px; width:100%;">';

      // Header
      html += "<thead><tr>";
      rows[0].forEach(col => html += `<th>${col}</th>`);
      html += "</tr></thead><tbody>";

      // Data
      for (let i = 1; i < rows.length; i++) {
        html += "<tr>";
        rows[i].forEach(cell => {
          // ตรวจสอบถ้ามีคำว่า 'Offline' หรือ 'Online'
          let color = "";
          if (cell.toLowerCase().includes("offline")) {
            color = "color: white;";
          } else if (cell.toLowerCase().includes("online")) {
            color = "color: white;";
          }
          html += `<td style="${color}">${cell}</td>`;
        });
        html += "</tr>";
      }

      html += "</tbody></table>";
      document.getElementById("link-to-grafana").innerHTML = html;
    });
  </script>

  <script>
  fetch("https://docs.google.com/spreadsheets/d/1Bbr3N3UjtIMpI1dlIwKBLOYn-_avAWDkgWPln4XxfdQ/export?format=csv&gid=1585725188")
    .then(response => response.text())
    .then(csv => {
      const rows = csv.trim().split("\n").map(r => r.split(","));
      let html = '<table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; font-size:16px; width:100%;">';

      // สร้างส่วนหัวตาราง
      html += "<thead><tr>";
      rows[0].forEach(col => html += `<th>${col}</th>`);
      html += "</tr></thead><tbody>";

      // สร้างข้อมูลในแต่ละแถว
      for (let i = 1; i < rows.length; i++) {
        html += "<tr>";
        rows[i].forEach(cell => {
          let style = "";
          const lower = cell.toLowerCase();
          if (lower.includes("offline")) {
            style = "color:white; font-weight:bold;";
          } else if (lower.includes("online")) {
            style = "color:white; font-weight:bold;";
          }
          html += `<td style="${style}">${cell}</td>`;
        });
        html += "</tr>";
      }

      html += "</tbody></table>";
      document.getElementById("logistics-table").innerHTML = html;
    });
  </script>

  <script>
  function toggleMiniPanel() {
    const panel = document.getElementById('miniPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  }
  </script>

  <script>
  function openLogistics(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add("active");
  }

  function closeLogistics(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove("active");
  } 
  </script>

  <script>
  function closeAllModals() {
    const modals = [
      'logisticsCenterModal',
      'CCTVSecurity',
      'CCTV-WH',
      'CCTV-UDS',
      'CCTV-HQ',
      'ElectricalSystem',
      'WaterSystem',
      'FreshAir',
      'SolarCell',
      'FiberOptic'
    ];
    modals.forEach(id => document.getElementById(id).classList.remove("active"));
  }

  function removeButtonHighlights() {
    document.querySelectorAll(".menu-buttons button").forEach(btn => {
      btn.classList.remove("highlight");
    });
  }
  </script>

  <script>
  let autoViewRunning = false;
  let autoViewTimer = null;
  let autoViewButton = null;
  let index = 0;

  const modals = [
    'logisticsCenterModal',
    'BUILDING_OVERVIEW',
    '3D_Digital',
    '4D_Digital',
    'CCTVSecurity',
    'CCTV-WH',
    'CCTV-UDS',
    'CCTV-HQ',
    'ElectricalSystem',
    'WaterSystem',
    'FreshAir',
    'SolarCell',
    'FiberOptic'
  ];

  const buttonMap = {
    'logisticsCenterModal': 'Logistics',
    'BUILDING_OVERVIEW': 'BUILDING OVERVIEW',
    '3D_Digital': '3D Digital Twin',
    '4D_Digital': '4D Digital Twin',
    'CCTVSecurity': 'CCTV Security',
    'CCTV-WH': 'CCTV-WH',
    'CCTV-UDS': 'CCTV-UDS',
    'CCTV-HQ': 'CCTV-HQ',
    'ElectricalSystem': 'Electrical System',
    'WaterSystem': 'Water System',
    'FreshAir': 'Fresh Air',
    'SolarCell': 'Solar Cell',
    'FiberOptic': 'Fiber Optic'
  };

  function closeAllModals() {
    modals.forEach(id => document.getElementById(id).classList.remove("active"));
  }

  function removeButtonHighlights() {
    document.querySelectorAll(".menu-buttons button").forEach(btn => {
      btn.classList.remove("highlight");
    });
  }

  function openNextModal() {
    if (!autoViewRunning) return;

    closeAllModals();
    removeButtonHighlights();

    if (index >= modals.length) index = 0;

    const id = modals[index];
    const label = buttonMap[id];
    const button = [...document.querySelectorAll(".menu-buttons button")]
                    .find(b => b.innerText.includes(label));
    if (button) {
      button.classList.add("highlight");
    }

    document.getElementById(id).classList.add("active");

    let delay = 6000; // default 5 วิ

    if (id === 'CCTV-WH') {
      delay = 6000;
    }

    if (id === 'CCTV-UDS') {
      delay = 6000;
    }

    if (id === 'CCTV-HQ') {
      delay = 6000;
    }

    if (id === 'FiberOptic') {
      delay = 6000; // แสดง Solar Cell นาน 10 วิ
      setTimeout(() => {
        document.getElementById(id).classList.remove("active");
        removeButtonHighlights();
      }, 6000); // ปิด Solar หลัง 10 วิ
      delay += 180000; // รอเพิ่มอีก 10 วิ รวม 20 วิ
    }

    index++;
    autoViewTimer = setTimeout(openNextModal, delay);
  }

  function runDemo() {
    if (!autoViewButton) {
      autoViewButton = document.querySelector(".menu-buttons button");
    }

    if (!autoViewRunning) {
      autoViewRunning = true;
      autoViewButton.classList.add("highlight");
      autoViewButton.innerText = "⏹ Stop";
      index = 0;
      openNextModal();
    } else {
      autoViewRunning = false;
      clearTimeout(autoViewTimer);
      closeAllModals();
      removeButtonHighlights();
      autoViewButton.classList.remove("highlight");
      autoViewButton.innerText = "▶ Auto View";
    }
  }
  </script>

  <script>
    function setBackgroundByTime() {
      const hour = new Date().getHours();
      const iframe = document.getElementById("background-frame");

      let src = "";
      if (hour >= 0 && hour < 8) {
        src = "https://sketchfab.com/models/65a75a890cfe4b63b1e3c7e41e524e36/embed?autostart=1&annotations_visible=0&annotation_cycle=5";
      } else if (hour >= 8 && hour < 16) {
        src = "https://sketchfab.com/models/fd7092ffbe88421dbbf9e19dd36894e9/embed?autostart=1&annotations_visible=0&annotation_cycle=5";
      } else {
        src = "https://sketchfab.com/models/9fe00d65cf0c4dec92cf1c6fb7be9e02/embed?autostart=1&annotations_visible=0&annotation_cycle=5";
      }

      iframe.src = src;
    }

    setBackgroundByTime();
  </script>

  <script>
    function formatCeil2(num) {
        const n = parseFloat(num);
        if (isNaN(n)) return num; // ถ้าไม่ใช่ตัวเลข คืนค่าเดิม
        return Math.ceil(n * 100) / 100;
    }

    function getTextFromGoogleSheet(cameraId) {
      const sheetID = "1pG8ldAgtHsOzlVxjITuBp2XCS77Sdk15fvmR-YU-MDg";
      const sheetName = "Data_EachFloor";
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;

      fetch(url)
        .then(res => res.text())
        .then(data => {
          const jsonData = JSON.parse(data.substr(47).slice(0, -2));
          const rows = jsonData.table.rows;

          for (let i = 0; i < rows.length; i++) {
            const row = rows[i].c;
            if (row[0] && row[0].v === cameraId) {
            
              // กล้องตัวแทนชั้น
              const img0  = row[2]?.v || '';
              const modalImg0 = document.getElementById("modalImg0");
              if (modalImg0 && img0) modalImg0.src = img0;
              
              // กล้อง 1
              const img1  = row[2]?.v || '';
              const text1 = row[1]?.v || 'ไม่พบข้อมูล';
              const text1_2 = row[23]?.v || 'ไม่พบข้อมูล';
              document.getElementById("name1").innerText = text1_2;
              const modalImg1 = document.getElementById("modalImg1");
              if (modalImg1 && img1) modalImg1.src = img1;
              document.getElementById("datetime1").innerText = text1;
              
              
              // กล้องที่กำลังเลือก
              const img9  = row[2]?.v || '';
              document.getElementById("name9").innerText = text1_2;
              const modalImg9 = document.getElementById("modalImg9");
              if (modalImg9 && img9) modalImg9.src = img9;
              document.getElementById("datetime9").innerText = text1;

              // กล้อง 2 (ถัดแถว)
              const row2  = rows[i+1]?.c || [];
              const img2  = row2[2]?.v || '';
              const text2 = row2[1]?.v || 'ไม่พบข้อมูล';
              const text2_2 = row2[23]?.v || 'ไม่พบข้อมูล';
              document.getElementById("name2").innerText = text2_2;
              const modalImg2 = document.getElementById("modalImg2");
              if (modalImg2 && img2) modalImg2.src = img2;
              document.getElementById("datetime2").innerText = text2;
              
              
              // กล้อง 3 (ถัดแถว)
              const row3  = rows[i+2]?.c || [];
              const img3  = row3[2]?.v || '';
              const text3 = row3[1]?.v || 'ไม่พบข้อมูล';
              const text3_2 = row3[23]?.v || 'ไม่พบข้อมูล';
              document.getElementById("name3").innerText = text3_2;
              const modalImg3 = document.getElementById("modalImg3");
              if (modalImg3 && img3) modalImg3.src = img3;
              document.getElementById("datetime3").innerText = text3;
              
              
              // กล้อง 4 (ถัดแถว)
              const row4  = rows[i+3]?.c || [];
              const img4  = row4[2]?.v || '';
              const text4 = row4[1]?.v || 'ไม่พบข้อมูล';
              const text4_2 = row4[23]?.v || 'ไม่พบข้อมูล';
              document.getElementById("name4").innerText = text4_2;
              const modalImg4 = document.getElementById("modalImg4");
              if (modalImg4 && img4) modalImg4.src = img4;
              document.getElementById("datetime4").innerText = text4;
              
              
              // กล้อง 5 (ถัดแถว)
              const row5  = rows[i+4]?.c || [];
              const img5  = row5[2]?.v || '';
              const text5 = row5[1]?.v || 'ไม่พบข้อมูล';
              const text5_2 = row5[23]?.v || 'ไม่พบข้อมูล';
              document.getElementById("name5").innerText = text5_2;
              const modalImg5 = document.getElementById("modalImg5");
              if (modalImg5 && img5) modalImg5.src = img5;
              document.getElementById("datetime5").innerText = text5;
              

              // กล้อง 6 (ถัดแถว)
              const row6  = rows[i+5]?.c || [];
              const img6  = row6[2]?.v || '';
              const text6 = row6[1]?.v || 'ไม่พบข้อมูล';
              const text6_2 = row6[23]?.v || 'ไม่พบข้อมูล';
              document.getElementById("name6").innerText = text6_2;
              const modalImg6 = document.getElementById("modalImg6");
              if (modalImg6 && img6) modalImg6.src = img6;
              document.getElementById("datetime6").innerText = text6;
              
              
              // กล้อง 7 (ถัดแถว)
              const row7  = rows[i+6]?.c || [];
              const img7  = row7[2]?.v || '';
              const text7 = row7[1]?.v || 'ไม่พบข้อมูล';
              const text7_2 = row7[23]?.v || 'ไม่พบข้อมูล';
              document.getElementById("name7").innerText = text7_2;
              const modalImg7 = document.getElementById("modalImg7");
              if (modalImg7 && img7) modalImg7.src = img7;
              document.getElementById("datetime7").innerText = text7;
              
              
              // กล้อง 8 (ถัดแถว)
              const row8  = rows[i+7]?.c || [];
              const img8  = row8[2]?.v || '';
              const text8 = row8[1]?.v || 'ไม่พบข้อมูล';
              const text8_2 = row8[23]?.v || 'ไม่พบข้อมูล';
              document.getElementById("name8").innerText = text8_2;
              const modalImg8 = document.getElementById("modalImg8");
              if (modalImg8 && img8) modalImg8.src = img8;
              document.getElementById("datetime8").innerText = text8;
              
                const para1 = row[3]?.v ?? 'ไม่พบข้อมูล';
                const para2 = row[4]?.v ?? 'ไม่พบข้อมูล';
                const para3 = row[5]?.v ?? 'ไม่พบข้อมูล';
                const para4 = row[6]?.v ?? 'ไม่พบข้อมูล';
                              
                const para5 = row[7]?.v ?? 'ไม่พบข้อมูล';
                const para6 = row[8]?.v ?? 'ไม่พบข้อมูล';
                const para7 = row[9]?.v ?? 'ไม่พบข้อมูล';
                const para8 = row[10]?.v ?? 'ไม่พบข้อมูล';
                                
                const para9 = row[11]?.v ?? 'ไม่พบข้อมูล';
                const para10 = row[12]?.v ?? 'ไม่พบข้อมูล';
                const para11 = row[13]?.v ?? 'ไม่พบข้อมูล';
                const para12 = row[14]?.v ?? 'ไม่พบข้อมูล';
                                
                const para13 = row[15]?.v ?? 'ไม่พบข้อมูล';
                const para14 = row[16]?.v ?? 'ไม่พบข้อมูล';
                const para15 = row[17]?.v ?? 'ไม่พบข้อมูล';
                const para16 = row[18]?.v ?? 'ไม่พบข้อมูล';
                                
                const para17 = row[19]?.v ?? 'ไม่พบข้อมูล';
                const para18 = row[20]?.v ?? 'ไม่พบข้อมูล';
                const para19 = row[21]?.v ?? 'ไม่พบข้อมูล';
                const para20 = row[22]?.v ?? 'ไม่พบข้อมูล';
                
                const para21 = row[24]?.v ?? 'ไม่พบข้อมูล';
                
                document.getElementById("infoBox2").innerHTML = para1;
                document.getElementById("infoBox3").innerHTML = para2;
                document.getElementById("infoBox4").innerHTML = para3;
                document.getElementById("infoBox5").innerHTML = para4;
                             
                document.getElementById("infoBox6").innerHTML  = formatCeil2(para5)  + "V";
                document.getElementById("infoBox7").innerHTML  = formatCeil2(para6)  + "A";
                document.getElementById("infoBox8").innerHTML  = formatCeil2(para7)  + "Hz";
                document.getElementById("infoBox9").innerHTML  = formatCeil2(para8)  + "kW";
                                
                document.getElementById("infoBox10").innerHTML = formatCeil2(para9)  + "<br>L/min";
                document.getElementById("infoBox11").innerHTML = formatCeil2(para10) + "<br>Days";
                document.getElementById("infoBox12").innerHTML = formatCeil2(para11) + "<br>Months";
                document.getElementById("infoBox13").innerHTML = formatCeil2(para12) + "<br>Liter";
                                
                document.getElementById("infoBox14").innerHTML = formatCeil2(para13) + "C";
                document.getElementById("infoBox15").innerHTML = formatCeil2(para14) + "%RH";
                document.getElementById("infoBox16").innerHTML = formatCeil2(para15) + "ug";
                document.getElementById("infoBox17").innerHTML = formatCeil2(para16) + "ug";
                                
                document.getElementById("infoBox18").innerHTML = formatCeil2(para17) + "ug";
                document.getElementById("infoBox19").innerHTML = formatCeil2(para18) + "ug";
                document.getElementById("infoBox20").innerHTML = formatCeil2(para19) + "<br>ppm";
                document.getElementById("infoBox21").innerHTML = formatCeil2(para20) + "<br>ppm";
             
                document.getElementById("NumberFloor").innerHTML = para21;

              break;
            }
          }
        })
        .catch(err => console.error("❌ Error loading Google Sheet:", err));
    }
    

  // === CONFIG: Mapping annotation name → model UID =========================
  const MODEL_START = '7adcd28260174cf58dd2672e1e189426'; // โมเดลรวมเริ่มต้น
  const ANNO_TO_MODEL = {
    '1st_Floor' : '78c790b7e74843139138cac1d852f05d',
    'M_Floor'   : '69350240005d4d43ae8800c5b7ab79d7',
    '2nd_Floor' : 'fae2731cfddc4b9dab3f43bed1724857',
    '3rd_Floor' : 'f5034d3514414c92aa4dc5d95c6513e7',
    '4th_Floor' : '317cf905f70c4e6fbce4beee8206c446',
    'Roof_Level': 'aeafd4ec7a1b49de83510bb3cf08bc7b'
  };
  // ========================================================================

  const iframe  = document.getElementById('skfb-frame');
  const client  = new Sketchfab(iframe);

  let activeUID   = null;
  let apiRef      = null;

  // ใช้ฟังก์ชันเดิมของคุณ: formatCeil2(), getTextFromGoogleSheet() ฯลฯ

  function initModel(uid){
    if (activeUID && uid === activeUID) return;   // กันโหลดซ้ำตัวเดิม
    
    activeUID = uid;
    client.init(uid, {
      autostart: 1,
      preload: 1,
      ui_infos: 0,
      ui_inspector: 0,
      ui_stop: 0,
      ui_watermark_link: 0,
      success: function(api){
        apiRef = api;
        api.start();

        api.addEventListener('viewerready', function(){
          const handler = function(index){
            api.getAnnotation(index, function(err, ann){
              if (err || !ann) return;

              // ---- พฤติกรรม "เดิม" ของคุณ: อัปเดตชื่อ/ข้อมูลจาก Google Sheet ----
              const CameraName = (ann.name || ann.title || '').trim();
              document.getElementById('cameraNameBox1').innerText = "Digital Building - " + CameraName;
              document.getElementById('cameraNameBox2').innerText = "Digital Building - " + CameraName;

              // โหลดข้อมูลแผ่น/การ์ด/ค่า metric ตามชื่อ CameraName (ฟังก์ชันเดิมของคุณ)
              getTextFromGoogleSheet(CameraName);

              // BUILDING vs FLOOR label + ซ่อน/โชว์การ์ด (ตรรกะเดิม)
              if (CameraName === "BPS_HQ") {
                document.getElementById('BuildorFloor').innerText = "BUILDING";
                hideAll();
              } else {
                document.getElementById('BuildorFloor').innerText = "FLOOR";
                showAll();
              }
              // --------------------------------------------------------------------

              // ถ้ามี mapping ชื่อ annotation → โมเดล ให้สลับไปโมเดลนั้น
              const targetUID = ANNO_TO_MODEL[CameraName];
              if (targetUID && targetUID !== activeUID){
                initModel(targetUID);
                hideCenterCCTV();
              }
            });
          };
          // รองรับทั้งสองอีเวนต์ของ Sketchfab
          api.addEventListener('annotationFocus',  handler);
          api.addEventListener('annotationSelect', handler);
        });
      },
      error: function(){ console.error('Sketchfab init error:', uid); }
    });
  }
  
  /* ===== Isometric Stack: ชั้นในสแต็ก (ไม่มี BPS) ===== */
(function(){
  // ใช้ key ให้ตรงกับ ANNO_TO_MODEL ของคุณ
  const LAYERS = [
    { key:'1st_Floor',  label:'1F' },
    { key:'M_Floor',    label:'M'  },
    { key:'2nd_Floor',  label:'2F' },
    { key:'3rd_Floor',  label:'3F' },
    { key:'4th_Floor',  label:'4F' },
    { key:'Roof_Level', label:'5F' }, // = 5th ใน mapping เดิม
  ];
  const BUTTONS = [
    { key:'BPS', label:'BPS', kind:'building' },
    ...LAYERS.map(x => ({...x, kind:'floor'}))
  ];

  const iso   = document.getElementById('isoIso');
  const stack = document.getElementById('isoStack');
  const chips = document.getElementById('isoChips');

  // ---------- สร้างเลเยอร์ (ล่าง -> บน) ----------
  LAYERS.forEach((f, i) => {
    const layer = document.createElement('div');
    layer.className = 'layer';
    layer.style.setProperty('--z', i);
    layer.style.setProperty('--delay', (i*0.08)+'s');
    layer.dataset.key = f.key;
    layer.setAttribute('data-label', f.label);

    const bar = document.createElement('div'); bar.className = 'bar';
    layer.appendChild(bar);

    const hit = document.createElement('div'); hit.className = 'hit';
    hit.setAttribute('role','button'); hit.setAttribute('tabindex','0');
    hit.setAttribute('aria-label','เลือกชั้น '+f.label);
    hit.addEventListener('click', () => selectFloor(f.key));
    hit.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); selectFloor(f.key); }});
    layer.appendChild(hit);

    stack.appendChild(layer);
  });

  // ---------- สร้างปุ่ม ----------
  BUTTONS.forEach((bMeta) => {
    const b = document.createElement('button');
    b.className = 'chip' + (bMeta.kind==='building' ? ' building' : '');
    b.textContent = bMeta.label;
    b.dataset.key = bMeta.key;

    // ใส่ uid ไว้เพื่อไฮไลต์ตามโมเดลที่แสดงอยู่
    b.dataset.uid = (bMeta.key==='BPS') ? (typeof MODEL_START!=='undefined'?MODEL_START:'') : (ANNO_TO_MODEL?.[bMeta.key]||'');

    b.addEventListener('click', () => {
      if(bMeta.key === 'BPS') selectAll();
      else selectFloor(bMeta.key);
    });
    chips.appendChild(b);
  });

  // ---------- Helper ----------
  function highlightByUID(uid){
    document.querySelectorAll('#isoChips .chip').forEach(c => {
      c.classList.toggle('active', c.dataset.uid === uid);
    });
  }
  function turnOnAllMode(on){
    stack.classList.toggle('all-mode', !!on);
    iso.classList.toggle('all-mode', !!on);
    // ทำให้ทุกชั้นติด active เพื่อเรืองแสงนุ่ม ๆ
    stack.querySelectorAll('.layer').forEach(l => l.classList.toggle('active', !!on));
  }
  function selectAll(){
    turnOnAllMode(true);
    // กลับโมเดลรวม + ซ่อนการ์ด Dock (พฤติกรรมเดิมของคุณ)
    try{ if (typeof hideAll==='function') hideAll(); }catch(e){}
    if (typeof initModel==='function' && typeof MODEL_START!=='undefined'){
      initModel(MODEL_START);
      highlightByUID(MODEL_START);
    }
  }
  function selectFloor(key){
    turnOnAllMode(false);
    // ไฮไลต์เฉพาะเลเยอร์ที่เลือก
    const layerList = [...stack.querySelectorAll('.layer')];
    layerList.forEach(l => l.classList.remove('active'));
    const target = layerList.find(l => l.dataset.key === key);
    if(target) target.classList.add('active');

    // เปิดโมเดลชั้นนั้น (พฤติกรรมเดิมของปุ่มเก่า)
    const uid = ANNO_TO_MODEL?.[key];
    if (uid){
      try{ if (typeof hideAll==='function') hideAll(); }catch(e){}
      if (typeof initModel==='function') initModel(uid);
      highlightByUID(uid);
    }else{
      console.warn('ไม่พบ UID ของชั้น:', key);
    }
  }

  // คีย์บอร์ด ↑/↓ ไหลไปทีละชั้น
  document.addEventListener('keydown', (e)=>{
    const list = LAYERS.map(x=>x.key);
    const activeUID = [...document.querySelectorAll('#isoChips .chip')].find(c=>c.classList.contains('active'))?.dataset.uid;
    let idx = list.findIndex(k => (ANNO_TO_MODEL?.[k]||'') === activeUID);
    if(idx < 0) idx = 0;
    if(e.key==='ArrowUp'){ idx = Math.min(list.length-1, idx+1); selectFloor(list[idx]); }
    else if(e.key==='ArrowDown'){ idx = Math.max(0, idx-1); selectFloor(list[idx]); }
  });

  // ---- Hook: ให้ทุกครั้งที่มีการเรียก initModel(uid) จากที่อื่น ระบบนี้จะ sync ไฮไลต์ให้เอง ----
  (function patchInitForIsoHighlight(){
    if (typeof initModel !== 'function') return;
    const _init = initModel;
    window.initModel = function(uid){
      const r = _init(uid);
      // ถ้าเป็นโมเดลรวม = BPS
      if (typeof MODEL_START!=='undefined' && uid === MODEL_START){
        turnOnAllMode(true);
      }else{
        turnOnAllMode(false);
      }
      highlightByUID(uid);
      return r;
    };
  })();

  // เริ่มต้นที่ BPS (ทั้งตึก)
  selectAll();
})();


  // เริ่มต้นที่โมเดลรวม
  initModel(MODEL_START);




  </script>
  
  <script>
    // ===== ฟังก์ชันโชว์/ซ่อนการ์ดใน Dock (ถ้าต้องการใช้) =====
    function openLogistics(id){ document.getElementById(id)?.classList.add('active'); }
    function closeLogistics(id){ document.getElementById(id)?.classList.remove('active'); }

    function setVisible(id, visible){
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = visible ? '' : 'none';
    }
    function showAll(){ 
        for(let i=1;i<=9;i++) setVisible('CCTV'+i, true); 
        for(let i=1;i<=2;i++) setVisible('cameraNameBox'+i, true); 
    }
    function hideAll(){ 
        for(let i=1;i<=9;i++) setVisible('CCTV'+i, false); 
        for(let i=1;i<=2;i++) setVisible('cameraNameBox'+i, false); 
    }
    function hideCenterCCTV(){
        setVisible('CCTV9', false);
    }
  </script>
  
<script>
  // ข้อมูล (แนวนอน = y คือหมวดหมู่, x คือค่า)
  var years = ['2023','2024','2025'];

  var trace1 = { 
    y: years,
    x: [20,14,23],
    name: 'Intruder',
    type: 'bar',
    orientation: 'h',
    marker: {
      color: '#00eaff',
      line: { width: 1.5, color: '#00ffff' }
    }
  };

  var trace2 = { 
    y: years,
    x: [12,18,29],
    name: 'Offline',
    type: 'bar',
    orientation: 'h',
    marker: {
      color: '#007bff',
      line: { width: 1.5, color: '#00ffff' }
    }
  };

  var data = [trace1, trace2];

  // คำนวณ max เพื่อขยายแกน x ให้แท่ง “ยาว” เต็มพื้นที่
  var maxX = Math.max(...trace1.x, ...trace2.x);
  var layout = { 
    barmode: 'group',
    bargap: 0.25,
    title: {
    text: 'Alarm Summary',      
    font: { family: 'Orbitron, sans-serif', size: 20, color: '#00ffff' }
    },
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    font: { family: 'Orbitron, sans-serif', color: '#e0faff' },

    // แกนแนวนอน (ความยาวของแท่ง)
    xaxis: {
      range: [0, Math.ceil(maxX * 1.25)],   // ขยาย 25% ให้แท่งดูยาวขึ้น
      gridcolor: '#00ffff33',
      tickfont: { color: '#00ffff' },
      zeroline: false
    },

    // แกนรายการ (ปี)
    yaxis: {
      tickfont: { color: '#00ffff' },
      gridcolor: '#00ffff22',
      automargin: true
    },

    // Legend ล่าง แนวนอน
    legend: {
      orientation: 'h',
      x: 0.5, xanchor: 'center',
      y: -0.2, yanchor: 'top',
      font: { color: '#00ffff' },
      bgcolor: 'rgba(0,0,0,0)'
    },

    margin: { l: 60, r: 12, t: 48, b: 60 }
  };

  var config = { displayModeBar: false, responsive: true };

  Plotly.newPlot('groupedBar', data, layout, config);
</script>

<script>
  var dataFloor = [{
    values: [15, 20, 25, 18, 22],  
    labels: ['1st_Floor', '2nd_Floor', '3rd_Floor', '4th_Floor', '5th_Floor (M_Floor)'],
    type: 'pie',
    hole: .4, // Donut
    marker: {
      colors: ['#00eaff','#00bfff','#0099ff','#007bff','#0055ff'],
      line: { color: '#00ffff', width: 2 }
    },
    textinfo: "label+percent",
    textfont: { family: 'Orbitron, sans-serif', color: '#e0faff', size: 13 }
  }];

  var layoutFloor = {
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    font: { family: 'Orbitron, sans-serif', color: '#e0faff' },
    legend: {
      orientation: 'h',
      x: 0.5, xanchor: 'center',
      y: -0.3, yanchor: 'top',
      font: { color: '#00ffff' },
      bgcolor: 'rgba(0,0,0,0)'
    },
    margin: { t: 20, b: 60 }
  };

  Plotly.newPlot('floorDonut', dataFloor, layoutFloor, {displayModeBar: false, responsive: true});
</script>

<script>
  var trace1 = {
    x: ['10:00','11:00','12:00','13:00','14:00'], // เวลา (Time)
    y: [10, 25, 18, 30, 45], // ปริมาณ (Volume)
    fill: 'tozeroy',
    type: 'scatter',
    mode: 'lines',
    line: { color: '#00eaff', width: 3 },
    fillcolor: 'rgba(0, 255, 255, 0.25)',
    name: 'Volume'
  };

  var data = [trace1];

  var layout = { 
    title: {
      text: 'Area Chart',
      font: { family: 'Orbitron, sans-serif', size: 22, color: '#00ffff' }
    },
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    font: { family: 'Orbitron, sans-serif', color: '#e0faff' },
    xaxis: {
      title: { text: 'Time', font: { color: '#00ffff' } },
      tickfont: { color: '#00ffff' },
      gridcolor: '#00ffff33',
      zeroline: false
    },
    yaxis: {
      title: { text: 'Volume', font: { color: '#00ffff' } },
      tickfont: { color: '#00ffff' },
      gridcolor: '#00ffff33',
      zeroline: false
    },
    legend: {
      orientation: 'h',
      x: 0.5, xanchor: 'center',
      y: -0.2, yanchor: 'top',
      font: { color: '#00ffff' },
      bgcolor: 'rgba(0,0,0,0)'
    },
    margin: { l: 70, r: 30, t: 60, b: 80 }
  };

  Plotly.newPlot('area', data, layout, {displayModeBar: false, responsive: true});
</script>

<script>
  var radarData = [{
    type: 'scatterpolar',
    r: [39, 28, 15, 20, 45, 39], // ค่าตัวอย่างของแต่ละ parameter
    theta: ['PM2.5','PM10','TVDC','CH2O','CO2','PM2.5'], // ปิด loop ด้วย PM2.5
    fill: 'toself',
    name: 'Environment',
    line: { color: '#00eaff', width: 3 },
    fillcolor: 'rgba(0, 255, 255, 0.25)'
  }];

  var radarLayout = {
    title: {
      text: 'Air Quality Parameters',
      font: { family: 'Orbitron, sans-serif', size: 22, color: '#00ffff' }
    },
    polar: { 
      bgcolor: 'rgba(0,0,0,0)',
      radialaxis: { 
        visible: true,
        gridcolor: '#00ffff33',
        linecolor: '#00ffff',
        tickfont: { color: '#00ffff' }
      },
      angularaxis: {
        gridcolor: '#00ffff33',
        linecolor: '#00ffff',
        tickfont: { color: '#00ffff' }
      }
    },
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    font: { family: 'Orbitron, sans-serif', color: '#e0faff' },
    legend: {
      orientation: 'h',
      x: 0.5, xanchor: 'center',
      y: -0.2, yanchor: 'top',
      font: { color: '#00ffff' },
      bgcolor: 'rgba(0,0,0,0)'
    },
    margin: { t: 60, b: 80 }
  };

  Plotly.newPlot('radar', radarData, radarLayout, {displayModeBar: false, responsive: true});
</script>

  <script>
    // ข้อมูลตัวอย่าง
    var traceSent = { 
      x: ['Car1','Car2','Car3','Car4','Car5'], 
      y: [20, 14, 23, 25, 18], 
      name: 'Sent', 
      type: 'bar',
      marker: { color: '#00eaff', line: { width: 1.5, color: '#00ffff' } }
    };

    var traceHold = { 
      x: ['Car1','Car2','Car3','Car4','Car5'], 
      y: [12, 18, 29, 17, 22], 
      name: 'Hold', 
      type: 'bar',
      marker: { color: '#007bff', line: { width: 1.5, color: '#00ffff' } }
    };

    var data = [traceSent, traceHold];

    var layout = { 
      barmode: 'stack',
      title: {
        text: 'Logistics Status',
        font: { family: 'Orbitron, sans-serif', size: 22, color: '#00ffff' }
      },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)',
      font: { family: 'Orbitron, sans-serif', color: '#e0faff' },
      xaxis: {
        title: { text: 'Vehicles', font: { color: '#00ffff' } },
        tickfont: { color: '#00ffff' },
        gridcolor: '#00ffff33',
        zeroline: false
      },
      yaxis: {
        title: { text: 'Orders', font: { color: '#00ffff' } },
        tickfont: { color: '#00ffff' },
        gridcolor: '#00ffff33',
        zeroline: false
      },
      legend: {
        orientation: 'h',
        x: 0.5, xanchor: 'center',
        y: -0.2, yanchor: 'top',
        font: { color: '#00ffff' },
        bgcolor: 'rgba(0,0,0,0)'
      },
      margin: { l: 70, r: 30, t: 60, b: 80 }
    };

    Plotly.newPlot('stackedBar', data, layout, {displayModeBar: false, responsive: true});
  </script>

<script>
  // เรียกใช้งาน: renderSolarHalo('solarHalo', powerArray[24]);
  // ถ้าไม่ส่ง powerArray จะใช้ตัวอย่างข้อมูลอัตโนมัติ
  function renderSolarHalo(containerId, powerArray) {
    const hours = [...Array(24)].map((_, i) => i); // 0..23

    // ตัวอย่างโค้งกำลังผลิต (พาราโบลา พีคช่วงเที่ยง)
    const sample = hours.map(h => {
      const x = (h - 12) / 6;
      const base = Math.max(0, 1 - x * x);
      return Math.round(base * 1000); // W
    });

    const power = Array.isArray(powerArray) && powerArray.length === 24 ? powerArray : sample;

    const trace = {
      type: 'scatterpolar',
      r: power,
      theta: hours.map(h => `${h}:00`),
      fill: 'toself',
      mode: 'lines',
      line: { color: '#00eaff', width: 3 },
      fillcolor: 'rgba(0,255,255,0.25)',
      name: 'Power'
    };

    const layout = {
      paper_bgcolor: 'rgba(0,0,0,0)',
      font: { family: 'Orbitron, sans-serif', color: '#e0faff' },
      polar: {
        bgcolor: 'rgba(0,0,0,0)',
        radialaxis: { gridcolor: '#00ffff33', tickfont: { color: '#00ffff' } },
        angularaxis:{ gridcolor: '#00ffff33', tickfont: { color: '#00ffff' } }
      },
      legend: {
        orientation: 'h', x: 0.5, xanchor: 'center', y: -0.2,
        bgcolor: 'rgba(0,0,0,0)', font: { color: '#00ffff' }
      },
      margin: { t: 10, b: 60, l: 10, r: 10 }
    };

    Plotly.newPlot(containerId, [trace], layout, { displayModeBar:false, responsive:true });
  }

  // ▶ ตัวอย่างการเรียก (ลบ/แก้ได้ตามจริง)
  renderSolarHalo('solarHalo');
</script>

<script>
  // เรียกใช้งาน: renderSolarCalendar('solarCal', 30, dailyArray);
  // dailyArray = อาร์เรย์ค่าพลังงานรายวันยาวเท่าจำนวนวัน (เช่น 30 ค่า) หน่วย kWh/วัน
  // ถ้าไม่ส่ง dailyArray จะใช้ตัวอย่างข้อมูลอัตโนมัติ
  function renderSolarCalendar(containerId, daysInMonth, dailyArray) {
    const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
    const weeks = Math.ceil(daysInMonth / 7);
    const weekLabels = Array.from({ length: weeks }, (_, i) => `Week ${i + 1}`);

    // เตรียมเมทริกซ์ weeks x 7
    const grid = Array.from({ length: weeks }, () => Array(7).fill(null));

    // ตัวอย่างข้อมูล: สูงช่วงกลางเดือน
    const sample = days.map(d => Math.round(30 + 20 * Math.sin((d / daysInMonth) * Math.PI)));
    const data = Array.isArray(dailyArray) && dailyArray.length === daysInMonth ? dailyArray : sample;

    days.forEach((d, i) => {
      const w = Math.floor(i / 7); // สัปดาห์
      const c = i % 7;             // วัน 0..6 (Mon..Sun)
      if (w < grid.length) grid[w][c] = data[i];
    });

    const heat = {
      z: grid,
      x: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
      y: weekLabels,
      type: 'heatmap',
      hoverongaps: false,
      colorscale: [
        [0,   'rgba(0,40,80,1)'],
        [0.3, 'rgba(0,120,180,1)'],
        [0.6, 'rgba(0,200,255,1)'],
        [1,   'rgba(0,255,255,1)']
      ],
      colorbar: { tickfont: { color: '#00ffff' }, title: { text: 'kWh/day', side: 'right', font: { color: '#00ffff' } } }
    };

    const layout = {
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)',
      font: { family: 'Orbitron, sans-serif', color: '#e0faff' },
      xaxis: { tickfont: { color: '#00ffff' }, gridcolor: '#00ffff33' },
      yaxis: { tickfont: { color: '#00ffff' }, gridcolor: '#00ffff33' },
      margin: { l: 60, r: 20, t: 10, b: 40 }
    };

    Plotly.newPlot(containerId, [heat], layout, { displayModeBar:false, responsive:true });
  }

  // ▶ ตัวอย่างการเรียก (ลบ/แก้ได้ตามจริง)
  renderSolarCalendar('solarCal', 30);
</script>

<script>
const parameters = {
  CCTV: ["Offline","Online","Intruder","Total"],
  Electrical: ["Voltage","Current","Power","Frequency"],
  Water: ["Flow Rate","Water Usage","Duration (Months)","Duration (Days)"],
  Air: ["Temperature","Humidity","PM2.5","PM10","CO2","TVOC","CH2O"]
};

const floors = ["1st_Floor","M_Floor","2nd_Floor","3rd_Floor","4th_Floor","5th_Floor"];
const neonPalette = ["#00FFFF", "#7DF9FF", "#8A2BE2", "#FF00FF", "#00FF7F", "#FF1493", "#1E90FF", "#00CED1"];
const pointsPerTrace = 72; // ขยายแกน X 3 เท่า
const xAxisValues = [...Array(pointsPerTrace).keys()];

// สร้างข้อมูลสุ่ม realistic
function generateData(param) {
  const base = {
    "Offline":[0,5], "Online":[5,20], "Intruder":[0,2], "Total":[5,20],
    "Voltage":[210,230], "Current":[1,30], "Power":[0.5,10], "Frequency":[49,51],
    "Flow Rate":[0,1], "Water Usage":[10,100], "Duration (Months)":[1,12], "Duration (Days)":[1,30],
    "Temperature":[22,28], "Humidity":[40,60], "PM2.5":[5,25], "PM10":[10,50],
    "CO2":[400,800], "TVOC":[0,1], "CH2O":[0,0.1]
  };
  const [min,max] = base[param] || [0,50];
  return Array.from({length:pointsPerTrace}, ()=> +(Math.random()*(max-min)+min).toFixed(2));
}

// สร้าง traces 3D
let data3D = [];
floors.forEach(floor=>{
  Object.keys(parameters).forEach(system=>{
    parameters[system].forEach((param,i)=>{
      const color = neonPalette[i % neonPalette.length];
      data3D.push({
        x: xAxisValues,
        y: Array(pointsPerTrace).fill(floor),
        z: generateData(param),
        mode: 'lines',
        type: 'scatter3d',
        name: `${floor} - ${param} - ${system}`,
        line: {width:3, color:color},
        visible: true
      });
    });
  });
});

// Layout 3D โปร่งใส
const layout3D = {
  paper_bgcolor:'rgba(0,0,0,0)',
  plot_bgcolor:'rgba(0,0,0,0)',
  showlegend:false,
  scene:{
    xaxis:{title:'Hour', gridcolor:'rgba(0,255,255,0.2)', backgroundcolor:'rgba(0,0,0,0)'},
    yaxis:{title:'Floor', tickvals:[...Array(floors.length).keys()], ticktext:floors, gridcolor:'rgba(0,255,255,0.2)', backgroundcolor:'rgba(0,0,0,0)'},
    zaxis:{title:'Value', gridcolor:'rgba(0,255,255,0.2)', backgroundcolor:'rgba(0,0,0,0)'},
    camera:{eye:{x:1.25,y:1.5,z:1}}
  },
  margin:{l:0,r:0,b:0,t:0},
  legend:{orientation:'h', x:0.5, xanchor:'center', y:-0.2, font:{color:'#0ff'}, bgcolor:'rgba(0,0,0,0)'}
};

Plotly.newPlot('dashboard3D', data3D, layout3D, {responsive:true, displayModeBar:true});

// Legend toggle
let legendVisible = false;
document.getElementById('legendToggle3D').addEventListener('click', ()=>{
  legendVisible = !legendVisible;
  document.getElementById('legendToggle3D').innerText = legendVisible ? 'Hide Legend' : 'Show Legend';
  Plotly.relayout('dashboard3D', {showlegend:legendVisible});
});

// Update paramSelect
const systemSelect = document.getElementById('systemSelect3D');
const paramSelect = document.getElementById('paramSelect3D');
const floorSelect = document.getElementById('floorSelect3D');

systemSelect.addEventListener('change', ()=>{
  const sys = systemSelect.value;
  paramSelect.innerHTML = '<option value="ALL">All Parameters</option>';
  if(parameters[sys]) parameters[sys].forEach(p=> paramSelect.innerHTML += `<option value="${p}">${p}</option>`);
  updateVisibility3D();
});

floorSelect.addEventListener('change', updateVisibility3D);
paramSelect.addEventListener('change', updateVisibility3D);

function updateVisibility3D(){
  const selFloor = floorSelect.value;
  const selSys = systemSelect.value;
  const selParam = paramSelect.value;

  data3D.forEach(trace=>{
    const [floor,param,system] = trace.name.split(' - ');
    trace.visible = (selFloor==='ALL'||floor===selFloor) &&
                    (selSys==='ALL'||system===selSys) &&
                    (selParam==='ALL'||param===selParam);
  });

  Plotly.react('dashboard3D', data3D, layout3D, {responsive:true, displayModeBar:true});
}
</script>

<script>
    const floors4D = ["1st_Floor","M_Floor","2nd_Floor","3rd_Floor","4th_Floor","5th_Floor"];
    const hours4D = [...Array(24).keys()];
    const params4D = ["CO2","Temperature","Humidity","PM2.5"];
    const neonColors4D = ["#00FFFF","#7DF9FF","#8A2BE2","#FF00FF","#00FF7F","#FF1493","#1E90FF","#00CED1"];

    function generate4DData(param){
      const data=[];
      floors4D.forEach((floor,fIndex)=>{
        hours4D.forEach(hour=>{
          const value = +(Math.random() * (param==="CO2"?40: param==="Temperature"?28: param==="Humidity"?60:25) + (param==="CO2"?400: param==="Temperature"?22: param==="Humidity"?40:5)).toFixed(1);
          data.push({x:hour,y:fIndex,z:value,size:value/10+1,color:value,floor:floor,hour:hour,param:param});
        });
      });
      return data;
    }

    let currentParam4D = "CO2";
    let rawData4D = generate4DData(currentParam4D);

    function createTrace4D(param){
      const filtered = rawData4D.filter(d=>d.param===param);
      return {
        x: filtered.map(d=>d.x),
        y: filtered.map(d=>d.y),
        z: filtered.map(d=>d.z),
        mode:'markers',
        type:'scatter3d',
        marker:{
          size: filtered.map(d=>d.size),
          color: filtered.map((d,i)=>neonColors4D[i%neonColors4D.length]),
          opacity:0.8,
          line:{width:2,color:'#0ff'},
          colorbar:{title:param,tickfont:{color:'#0ff'}}
        },
        text: filtered.map(d=>`${d.floor} - Hour ${d.hour} - ${param}: ${d.z}`),
        hoverinfo:'text'
      };
    }

    const trace4D = createTrace4D(currentParam4D);

    const layout4D = {
      paper_bgcolor:'rgba(0,0,0,0)',
      plot_bgcolor:'rgba(0,0,0,0)',
      scene:{
        xaxis:{title:'Hour', gridcolor:'rgba(0,255,255,0.2)'},
        yaxis:{title:'Floor', tickvals:floors4D.map((_,i)=>i), ticktext:floors4D, gridcolor:'rgba(0,255,255,0.2)'},
        zaxis:{title:'Value', gridcolor:'rgba(0,255,255,0.2)'},
        camera:{eye:{x:1.5,y:2,z:1.5}}
      },
      margin:{l:0,r:0,b:0,t:0},
      showlegend:false
    };

    Plotly.newPlot('dashboard4D',[trace4D],layout4D,{responsive:true,displayModeBar:true});

    const paramSelect4D = document.getElementById('paramSelect4D');
    const floorSelect4D = document.getElementById('floorSelect4D');

    paramSelect4D.addEventListener('change', e=>{
      currentParam4D = e.target.value;
      rawData4D = generate4DData(currentParam4D);
      Plotly.react('dashboard4D',[createTrace4D(currentParam4D)],layout4D,{responsive:true,displayModeBar:true});
    });

    floorSelect4D.addEventListener('change', e=>{
      const floor = e.target.value;
      let filteredData = rawData4D;
      if(floor!=="ALL") filteredData = rawData4D.filter(d=>d.floor===floor);
      Plotly.react('dashboard4D',[{
        x: filteredData.map(d=>d.x),
        y: filteredData.map(d=>d.y),
        z: filteredData.map(d=>d.z),
        mode:'markers',
        type:'scatter3d',
        marker:{
          size: filteredData.map(d=>d.size),
          color: filteredData.map((d,i)=>neonColors4D[i%neonColors4D.length]),
          opacity:0.8,
          line:{width:2,color:'#0ff'}
        },
        text: filteredData.map(d=>`${d.floor} - Hour ${d.hour} - ${d.param}: ${d.z}`),
        hoverinfo:'text'
      }],layout4D,{responsive:true,displayModeBar:true});
    });
  </script>
  
  <script>
    /* เพิ่ม sheen เข้าไปใน card */
    document.querySelectorAll('.floor-card').forEach(c=>{
      const s = document.createElement('i');
      s.className = 'sheen';
      c.appendChild(s);
    });
  </script>
  

<script>
  // === ปุ่มเลือกชั้น (รวม Home) =======================================
  const floorButtonsContainerId = 'floorButtons';

  // ป้ายชื่อสวย ๆ สำหรับปุ่มแต่ละชั้น
  const LABELS = {
    'HOME':        'BPS',
    '1st_Floor':   '1F',
    'M_Floor':     'M',
    '2nd_Floor':   '2F',
    '3rd_Floor':   '3F',
    '4th_Floor':   '4F',
    'Roof_Level':  '5F'
  };

  // สร้าง spec ของปุ่ม: Home + แต่ละชั้นตาม ANNO_TO_MODEL (ลำดับอิงการประกาศ)
  const FLOOR_BTNS = [
    { key: 'HOME', uid: MODEL_START, label: LABELS['HOME'] },
    ...Object.entries(ANNO_TO_MODEL).map(([k, uid]) => ({
      key: k, uid, label: LABELS[k] || k.replace(/_/g,' ')
    }))
  ];

  // กัน push ประวัติตอนกลับ Home (ถ้ามีธงจากโค้ดเดิมจะใช้ด้วย)
  let _localSuppress = false;

  function renderFloorButtons(){
    const container = document.getElementById(floorButtonsContainerId);
    if (!container) return;

    container.innerHTML = '';
    FLOOR_BTNS.forEach(spec => {
      const btn = document.createElement('button');
      btn.textContent = spec.label;
      btn.dataset.uid = spec.uid;
      btn.title = `Go to ${spec.label}`;
      btn.addEventListener('click', () => {
        if (spec.uid === MODEL_START) {
          // กลับ Home: เคลียร์สแต็ค Back และไม่ push ประวัติปัจจุบัน
          try { if (typeof historyStack !== 'undefined') historyStack.length = 0; } catch(e){}
          // ใช้ธง suppress ของระบบเดิมถ้ามี ไม่งั้นใช้โลคอล
          const hasGlobalSuppress = (typeof suppressHistoryPush !== 'undefined');
          if (hasGlobalSuppress) suppressHistoryPush = true; else _localSuppress = true;
          initModel(MODEL_START);
          if (hasGlobalSuppress) suppressHistoryPush = false; else _localSuppress = false;
        } else {
          initModel(spec.uid);
        }
      });
      container.appendChild(btn);
    });
  }

  // ไฮไลต์ปุ่มของโมเดลที่กำลังเปิดอยู่
  function highlightFloor(uid){
    const selector = `#${floorButtonsContainerId} button`;
    document.querySelectorAll(selector).forEach(b => {
      b.classList.toggle('highlight', b.dataset.uid === uid);
    });
  }

  // --- ผูกเข้ากับ initModel เดิมให้ไฮไลต์อัปเดตอัตโนมัติ ---
  // ถ้าอยากแทรกแบบไม่แก้ initModel มาก ให้สอดบรรทัด highlight ไว้ตอนท้ายของ initModel ด้วยก็ได้
  // แต่ถ้าไม่สะดวกแก้ในนั้น เราจะ hook แบบนี้:
  (function patchInitHighlight(){
    const _init = initModel;
    window.initModel = function(uid){
      // ถ้าเราใช้ suppress ชั่วคราวเอง ให้เลียนแบบ suppressHistoryPush = true
      if (_localSuppress && typeof suppressHistoryPush === 'undefined') {
        // ดักไว้เฉย ๆ ไม่ต้องทำอะไร เพราะเราเคลียร์ stack ไปก่อนแล้ว
      }
      const ret = _init(uid);
      // หลังสลับโมเดลแล้ว ให้ไฮไลต์ปุ่ม
      try { highlightFloor(uid); } catch(e){}
      return ret;
    };
  })();

  // เรียกครั้งแรก
  renderFloorButtons();
  // ไฮไลต์ Home ตอนเริ่ม
  highlightFloor(MODEL_START);
</script>

<script>
  // === Floor buttons (Home + Floors) =================================
  const LABELS = {
    'HOME':        'BPS',
    '1st_Floor':   '1F',
    'M_Floor':     'M',
    '2nd_Floor':   '2F',
    '3rd_Floor':   '3F',
    '4th_Floor':   '4F',
    'Roof_Level':  '5F'
  };

  const FLOOR_BTNS = [
    { key: 'HOME', uid: MODEL_START, label: LABELS['HOME'] },
    ...Object.entries(ANNO_TO_MODEL).map(([k, uid]) => ({
      key: k, uid, label: LABELS[k] || k.replace(/_/g,' ')
    }))
  ];

  function renderFloorButtons(){
    const container = document.getElementById('floorButtons');
    if (!container) return;
    container.innerHTML = '';
    FLOOR_BTNS.forEach(spec => {
      const b = document.createElement('button');
      b.className = 'chip';
      b.textContent = spec.label;
      b.dataset.uid = spec.uid;
      b.title = `Go to ${spec.label}`;
      b.addEventListener('click', () => {
        if (spec.uid === MODEL_START){
          // กลับบ้านแบบเคลียร์สแต็ค
          if (typeof historyStack !== 'undefined') historyStack.length = 0;
          if (typeof suppressHistoryPush !== 'undefined'){ suppressHistoryPush = true; }
          hideAll();             // ซ่อนการ์ดก่อน
          initModel(MODEL_START);
          if (typeof suppressHistoryPush !== 'undefined'){ suppressHistoryPush = false; }
        } else {
          hideAll();             // ซ่อนการ์ดก่อนเข้าโมเดลใหม่ทุกครั้ง
          initModel(spec.uid);
        }
      });
      container.appendChild(b);
    });
  }

  function highlightFloor(uid){
    document.querySelectorAll('#floorButtons .chip').forEach(ch => {
      ch.classList.toggle('active', ch.dataset.uid === uid);
    });
  }

  // hook ให้ไฮไลต์อัปเดตทุกครั้งที่เปลี่ยนโมเดล
  (function patchInitForHighlight(){
    const _init = initModel;
    window.initModel = function(uid){
      const r = _init(uid);
      try { highlightFloor(uid); } catch(e){}
      return r;
    };
  })();

  // เรียกครั้งแรก
  renderFloorButtons();
  highlightFloor(MODEL_START);
</script>




</body>
</html>

